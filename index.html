<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Policy-Sim (Normalbetrieb)</title>

  <!-- PyScript 2024.x (richtige Tags) -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.5.1/core.css" />
  <script defer src="https://pyscript.net/releases/2024.5.1/core.js"></script>

  <style>
    :root { color-scheme: dark; --bg:#0b0d12; --panel:#121521; --muted:#9aa4b2; --accent:#3478f6; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:#e6e9ef; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial }
    header{ padding:14px 18px; border-bottom:1px solid #1b2030; display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    header h1{ font-size:18px; margin:0 8px 0 0 }
    select,button,input{ background:#0f1320; color:#e6e9ef; border:1px solid #1f2638; padding:8px 10px; border-radius:8px }
    button.primary{ background:var(--accent); border:0; color:#fff; font-weight:700 }
    main{ display:grid; grid-template-columns:1.25fr .75fr; gap:18px; padding:18px; }
    .panel{ background:var(--panel); border:1px solid #1b2030; border-radius:12px; padding:14px }
    .phasebar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
    .chip{ padding:6px 10px; border-radius:999px; border:1px solid #1b2030; background:#121829; color:#b8c2d3; font-size:12px }
    .chip.active{ background:#1a2140; color:#fff }
    .scene-title{ font-weight:700; margin:0 0 8px 0 }
    .scene-text{ color:#d9dde6; margin:0 0 8px 0 }
    .actions{ margin-top:10px; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:10px }
    .act{ padding:10px; background:#121829; border:1px solid #1b2030; border-radius:10px; cursor:pointer; text-align:center }
    .infobox h4{ margin:0 0 8px 0; font-size:14px }
    .infobox ul{ margin:0; padding-left:16px; color:#b8c2d3 }
    .metrics{ display:grid; gap:8px; margin-top:8px }
    .barwrap{ background:#0f1320; border:1px solid #1b2030; border-radius:10px; position:relative; height:16px }
    .bar{ position:absolute; left:0; top:0; bottom:0 }
    .lab{ position:absolute; left:10px; top:2px; font-size:12px; color:#9aa4b2 }
    .val{ position:absolute; right:10px; top:2px; font-size:12px; color:#9aa4b2 }
    .vote{ margin-top:12px; padding:10px; border:1px dashed #2a3450; border-radius:10px }
    @media (max-width:860px){ main{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header>
    <h1>Policy-Sim (Normalbetrieb)</h1>

    <select id="speed">
      <option value="0.5">Cinematic (~4 min/Phase)</option>
      <option value="1.0" selected>Normal (~2 min/Phase)</option>
      <option value="2.0">Schnell (~1 min/Phase)</option>
    </select>

    <button id="start" class="primary">Start</button>
    <button id="skip">Szene überspringen</button>
    <button id="restart">Neues Thema</button>
  </header>

  <main>
    <section class="panel">
      <div class="phasebar" id="phasebar"></div>
      <h2 class="scene-title" id="sceneTitle">Willkommen</h2>
      <p class="scene-text" id="sceneText">Wähle ein Thema und starte den Probedurchlauf.</p>
      <div class="actions" id="actions"></div>
      <div class="vote" id="vote" style="display:none"></div>
    </section>

    <aside class="panel">
      <div class="infobox">
        <h4>Info</h4>
        <ul id="info"></ul>
      </div>
      <div class="metrics" id="metrics"></div>
      <div style="margin-top:10px">
        <label style="display:block;font-size:12px;color:#9aa4b2;margin-bottom:6px">Thema</label>
        <select id="topic" style="width:100%"></select>
      </div>
    </aside>
  </main>

  <!-- PyScript config must use the 2024.x tag syntax -->
  <script type="py-config">
packages = []
  </script>

  <script type="py">
from dataclasses import dataclass
from typing import Dict, List, Tuple
from js import document, window
import random, math

# ---------- Daten ----------
MBTI = ["ENTJ","INTJ","ENTP","INTP","ENFJ","INFJ","ENFP","INFP","ESTJ","ISTJ","ESFJ","ISFJ","ESTP","ISTP","ESFP","ISFP"]

DISC = ["Volkswirtschaft","Public Health","Epidemiologie","Klimawissenschaft",
        "Energiesysteme","Recht","Ethik/Grundrechte","Daten-/IT-Sicherheit",
        "Implementation/Verwaltung","Statistik/Methoden","Sozialpolitik",
        "Verkehr/Infrastruktur","Kommunikation","EU-Recht"]

# Themen (Schlüssel erscheinen im Dropdown)
PROBLEMS: Dict[str, List[str]] = {
    "KI-Regulierung in Behörden": ["Daten-/IT-Sicherheit","EU-Recht","Implementation/Verwaltung","Statistik/Methoden"],
    "Energiewende & Netzausbau": ["Energiesysteme","Klimawissenschaft","Recht","Verkehr/Infrastruktur"],
    "Wohnungsbau & Mieten": ["Volkswirtschaft","Sozialpolitik","Recht","Statistik/Methoden"],
    "Gesundheitsreform": ["Public Health","Epidemiologie","Volkswirtschaft","Sozialpolitik"],
    "Cybersicherheit Staat": ["Daten-/IT-Sicherheit","Recht","Implementation/Verwaltung","Kommunikation"],
    "Schule & Digitalisierung": ["Implementation/Verwaltung","Daten-/IT-Sicherheit","Statistik/Methoden","Sozialpolitik"],
}

PINFO: Dict[str, List[str]] = {
    "P1": ["Nur FachBEREICHE werden zuerst festgelegt, nicht konkrete Namen."],
    "P2": ["Thema wird auf Plattform veröffentlicht; Expert*innen bewerben sich."],
    "P3": ["Standard: max. zwei Vertreter pro Bereich; Diversität wird beachtet."],
    "P4": ["Runde 1: Evidenz, Wechselwirkungen, Nebenfolgen; Runde 2: Umsetzung."],
    "P5": ["Politische Abwägung und Entscheidung mit Begründung."],
}

@dataclass
class Agent:
    name: str
    role: str  # "Regierung", "Opposition", "Zivil", "Wirtschaft", "Verwaltung", "Experte"
    disc: str
    mbti: str

def mk_name(prefix: str, idx: int) -> str:
    return f"{prefix}#{idx}"

def political_pool() -> List[Agent]:
    pool: List[Agent] = []
    roles = [("Regierungsführung","Regierung",4),
             ("Oppositionsführung","Opposition",4),
             ("Wirtschaft","Wirtschaft",6),
             ("Zivilgesellschaft","Zivil",6),
             ("Verwaltung","Verwaltung",6)]
    for pref, role, n in roles:
        for i in range(1, n+1):
            disc = random.choice(DISC)
            pool.append(Agent(mk_name(pref,i), role, disc, random.choice(MBTI)))
    return pool

def expert_registry() -> Dict[str, List[Agent]]:
    reg: Dict[str, List[Agent]] = {}
    for d in DISC:
        reg[d] = [Agent(mk_name("Expertin", i), "Experte", d, random.choice(MBTI)) for i in range(1, 6)]
    return reg

def pick_members(scopes: List[str], pool: List[Agent], reg: Dict[str, List[Agent]]) -> Dict[str, List[Agent]]:
    # wähle je Bereich max zwei Expert*innen
    result: Dict[str, List[Agent]] = {}
    for d in scopes:
        lst = reg.get(d, [])
        random.shuffle(lst)
        result[d] = lst[:2]
    return result

# ---------- UI Hilfen ----------
def qs(id_: str):
    return document.getElementById(id_)

def set_text(id_: str, txt: str):
    qs(id_).textContent = txt

def set_html(id_: str, html: str):
    qs(id_).innerHTML = html

def hide(id_: str):
    qs(id_).style.display = "none"

def show(id_: str, disp="block"):
    qs(id_).style.display = disp

def render_phasebar(phases: List[str], active_index: int):
    el = qs("phasebar")
    el.innerHTML = ""
    for i, ph in enumerate(phases):
        chip = document.createElement("div")
        chip.classList.add("chip")
        if i == active_index:
            chip.classList.add("active")
        chip.textContent = ph
        el.appendChild(chip)

def render_vote(yes: int, tot: int):
    pct = 0 if tot == 0 else round(100*yes/tot)
    qs("vote").innerHTML = f"<b>Abstimmung:</b> {yes}/{tot} Stimmen, {pct}% Zustimmung"
    show("vote")

def clear_vote():
    hide("vote")
    qs("vote").innerHTML = ""

def metric(name: str, value: float):
    # einfache Balkenanzeige 0..1
    pct = max(0, min(100, int(value*100)))
    wrap = document.createElement("div")
    wrap.classList.add("barwrap")
    bar = document.createElement("div")
    bar.classList.add("bar")
    bar.style.width = f"{pct}%"
    bar.style.background = "linear-gradient(90deg,#3478f6,#42d392)"
    lab = document.createElement("div"); lab.classList.add("lab"); lab.textContent = name
    val = document.createElement("div"); val.classList.add("val"); val.textContent = f"{pct}%"
    wrap.appendChild(bar); wrap.appendChild(lab); wrap.appendChild(val)
    qs("metrics").appendChild(wrap)

# ---------- Storyboard ----------
Scene = Dict[str, object]

def describe_experts(experts: Dict[str, List[Agent]]) -> List[str]:
    lines: List[str] = []
    for d, lst in experts.items():
        names = ", ".join(f"{e.name.split('#')[0]} ({e.mbti})" for e in lst)
        lines.append(f"{d}: {names}" if names else f"{d}: –")
    return lines

def deliberate(experts: Dict[str, List[Agent]]) -> Tuple[str, Dict[str, float]]:
    # sehr vereinfachte "Bewertung" als Mittelwert: jede Disziplin gibt 0..1 Punkt
    vals: Dict[str, float] = {}
    for d, lst in experts.items():
        x = 0.5 + 0.1*(len(lst)) + (random.random()-0.5)*0.2
        vals[d] = max(0.0, min(1.0, x))
    # Gesamtscore für Entscheidung:
    score = sum(vals.values()) / max(1, len(vals))
    rationale = f"Gesamtscore (Evidenz & Umsetzbarkeit): {round(score*100)}%."
    return rationale, vals

def decide(polit_core: List[Agent], score: float) -> Tuple[str, int, int]:
    tot = len(polit_core)
    bias = 0.1 * (1 if score >= 0.5 else -1)
    yes = 0
    for _ in range(tot):
        base = score + bias + (random.random()-0.5)*0.2
        if base >= 0.5: yes += 1
    decision = "ADOPT" if yes >= math.ceil(2*tot/3) else ("PILOT" if yes >= math.ceil(tot/2) else "REJECT")
    return decision, yes, tot

def storyboard(topic: str, speed: float) -> List[Scene]:
    pool = political_pool()
    reg = expert_registry()
    scopes = PROBLEMS.get(topic, [])[:]
    polit_core = [a for a in pool if a.role in ("Regierung","Verwaltung")][:8]

    scenes: List[Scene] = []
    # P1 – Thema/Scopes
    scenes.append({
        "phase":"P1",
        "title":"Thema & Fachbereiche festlegen",
        "lines":[f"Thema: {topic}"] + PINFO["P1"] + ["Fachbereiche: " + ", ".join(scopes)],
        "acts":[("Weiter", "next")],
    })
    # P2 – Ausschreibung
    scenes.append({
        "phase":"P2",
        "title":"Ausschreibung & Bewerbungen",
        "lines":PINFO["P2"],
        "acts":[("Bewerbungen sichten", "next")],
    })
    # P3 – Auswahl
    experts = pick_members(scopes, pool, reg)
    scenes.append({
        "phase":"P3",
        "title":"Gremium zusammenstellen",
        "lines":["Ausgewählte Expert:innen:"] + describe_experts(experts),
        "acts":[("Gremium bestätigen", "next")],
    })
    # P4 – Beratung
    rationale, vals = deliberate(experts)
    scenes.append({
        "phase":"P4",
        "title":"Beratung & Evidenz",
        "lines":[rationale, "Zwischenindikatoren werden aktualisiert."],
        "metrics":vals,
        "acts":[("Zur Abstimmung", "next")],
    })
    # P5 – Entscheidung
    score = sum(vals.values())/max(1,len(vals))
    decision, yes, tot = decide(polit_core, score)
    vt = f"Abstimmung über Maßnahmenpaket ({topic})"
    scenes.append({
        "phase":"P5",
        "title":"Politische Entscheidung",
        "lines":[f"Ergebnis: {decision}.", f"{yes}/{tot} Stimmen zustimmend."],
        "vote":(yes, tot),
        "acts":[("Beenden", "end")],
    })
    return scenes

# ---------- Ablaufsteuerung ----------
SCENES: List[Scene] = []
idx = -1
remaining = 0
timer = None

def set_info(lines: List[str]):
    ul = qs("info"); ul.innerHTML = ""
    for ln in lines:
        li = document.createElement("li")
        li.textContent = ln
        ul.appendChild(li)

def render_scene():
    global SCENES, idx
    scene = SCENES[idx]
    phases = [s["phase"] for s in SCENES]
    render_phasebar(phases, idx)

    set_text("sceneTitle", scene["title"])
    set_html("sceneText", "<br>".join(scene.get("lines", [])))

    # metrics
    qs("metrics").innerHTML = ""
    for name, val in scene.get("metrics", {}).items():
        metric(name, float(val))

    # vote box
    clear_vote()
    if "vote" in scene:
        y, t = scene["vote"]
        render_vote(y, t)

    # actions
    acts_el = qs("actions"); acts_el.innerHTML = ""
    for label, code in scene.get("acts", []):
        btn = document.createElement("button")
        btn.classList.add("act")
        btn.textContent = label
        def handler(ev, c=code):
            if c == "next":
                next_scene()
            elif c == "end":
                end_run()
        btn.addEventListener("click", handler)
        acts_el.appendChild(btn)

def next_scene():
    global idx
    idx += 1
    if idx >= len(SCENES):
        end_run()
        return
    render_scene()

def end_run():
    set_text("sceneTitle", "Durchlauf beendet")
    set_text("sceneText", "Du kannst ein neues Thema wählen und erneut starten.")
    qs("actions").innerHTML = ""
    clear_vote()
    render_phasebar([], -1)

def start_run(evt=None):
    global SCENES, idx, timer
    if timer: 
        window.clearTimeout(timer)
    topic = qs("topic").value
    speed = float(qs("speed").value)
    SCENES = storyboard(topic, speed)
    idx = -1
    set_info([f"Thema: {topic}", "Phasen: " + ", ".join(s['phase'] for s in SCENES)])
    next_scene()

def skip_scene(evt=None):
    next_scene()

def restart(evt=None):
    # wählt ein zufälliges Thema und setzt UI zurück
    opts = list(PROBLEMS.keys())
    qs("topic").value = random.choice(opts)
    set_text("sceneTitle", "Neuer Durchlauf")
    set_text("sceneText", "Thema gewählt. Klicke auf Start.")
    qs("actions").innerHTML = ""
    clear_vote()
    qs("metrics").innerHTML = ""
    render_phasebar([], -1)

# ---------- Bootstrap ----------
# Dropdown mit Themen füllen
topic_sel = qs("topic"); topic_sel.innerHTML = ""
for k in PROBLEMS.keys():
    opt = document.createElement("option")
    opt.value = k; opt.textContent = k
    topic_sel.appendChild(opt)
# Default erstes Thema
if topic_sel.options.length > 0:
    topic_sel.value = topic_sel.options.item(0).value

# Buttons verbinden
qs("start").addEventListener("click", start_run)
qs("skip").addEventListener("click", skip_scene)
qs("restart").addEventListener("click", restart)
  </script>
</body>
</html>
