<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Policy-Sim (Normalbetrieb)</title>

  <!-- PyScript 2024.x -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.6.1/core.css">
  <script defer src="https://pyscript.net/releases/2024.6.1/core.js"></script>

  <style>
    :root { color-scheme: dark; --bg:#0b0d12; --panel:#0f1320; --accent:#2563eb }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:#e6ecff; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif }
    header{ padding:16px 18px; border-bottom:1px solid #1c2030; display:grid; gap:10px;
            grid-template-columns: 1fr auto auto auto }
    header h1{ font-size:18px; margin:0 8px 0 0 }
    select,button{ background:#0f1320; color:#e6ecff; border:1px solid #30364d; border-radius:8px; padding:8px 10px }
    button.primary{ background:var(--accent); border-color:var(--accent); color:white }
    main{ display:grid; grid-template-columns:1fr 360px; gap:14px; padding:14px; align-items:start }
    .panel{ background:var(--panel); border:1px solid #1b2030; border-radius:10px; padding:14px }
    .scene-title{ margin:0 0 6px 0 }
    .scene-text{ margin:0 0 10px 0; color:#cfd7ff }
    .actions{ margin-top:10px }
    .phasebar{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
    .chip{ padding:6px 10px; border-radius:999px; background:#11182a; color:#b9c4ff; border:1px solid #26304a }
    .chip.active{ background:#1a2140; color:#fff; border-color:#3a4a7a }
    .infobox h4{ margin:0 0 8px 0; font-size:13px; color:#b7c0ff }
    .infobox ul{ margin:0; padding-left:18px; font-size:13px; color:#b7c0ff }
    .metrics{ display:grid; gap:8px; margin-top:10px }
    @media (max-width:860px){ main{ grid-template-columns:1fr } }
  </style>
</head>
<body>
  <header>
    <h1>Policy-Sim (Normalbetrieb)</h1>

    <div>
      <label for="speed" style="display:block;font-size:12px;color:#9fb0ff">Tempo</label>
      <select id="speed">
        <option value="0.5">Cinematic (~4 min/Phase)</option>
        <option value="1.0" selected>Normal (~2 min/Phase)</option>
        <option value="2.0">Schnell (~1 min/Phase)</option>
      </select>
    </div>

    <div style="display:flex; gap:8px; align-items:center">
      <button id="start" class="primary" py-click="start_run()">Start</button>
      <button id="skip" py-click="skip_scene()">Szene überspringen</button>
      <button id="restart" py-click="restart()">Neues Thema</button>
    </div>
  </header>

  <main>
    <!-- linkes Panel: Story -->
    <section class="panel">
      <div class="phasebar" id="phasebar"></div>
      <h2 class="scene-title" id="sceneTitle">Willkommen</h2>
      <p class="scene-text" id="sceneText">Wähle ein Thema und starte den Probedurchlauf.</p>
      <div class="actions" id="actions"></div>
    </section>

    <!-- rechtes Panel: Info + Dropdown + Metriken -->
    <aside class="panel">
      <div class="infobox">
        <h4>Info</h4>
        <ul id="info"></ul>
      </div>

      <div class="metrics" id="metrics"></div>

      <div style="margin-top:10px">
        <label for="topic" style="display:block;font-size:12px;color:#9fb0ff">Thema</label>
        <!-- WICHTIG: Es gibt GENAU EIN select#topic -->
        <select id="topic" style="width:100%"></select>
      </div>
    </aside>
  </main>

  <!-- App-Logik (Python) -->
  <script type="py">
from js import document, window
import random

document.title = "Policy-Sim ✅"

# ---------- DOM-Helfer ----------
def qs(sel: str):
    if sel.startswith("#"):
        return document.getElementById(sel[1:])
    return document.querySelector(sel)

def set_text(id_: str, txt: str):
    el = qs("#"+id_) if not id_.startswith("#") else qs(id_)
    if el is not None:
        el.textContent = txt

def set_html(id_: str, html: str):
    el = qs("#"+id_) if not id_.startswith("#") else qs(id_)
    if el is not None:
        el.innerHTML = html

def set_info(lines):
    ul = qs("#info")
    ul.innerHTML = "" if not lines else "".join(f"<li>{line}</li>" for line in lines)

def set_metrics(vals):
    box = qs("#metrics")
    if not vals:
        box.innerHTML = ""
        return
    rows = [f"<div><b>{k}:</b> {v}</div>" for k, v in vals.items()]
    box.innerHTML = "".join(rows)

def render_phasebar():
    chips = []
    for i, s in enumerate(SCENES):
        cls = "chip active" if i == idx else "chip"
        chips.append(f'<span class="{cls}">{s.get("phase","P?")}</span>')
    set_html("phasebar", "".join(chips))

# ---------- Themen ----------
PROBLEMS = {
    "KI-Regulierung in Behörden": ["Daten/IT-Sicherheit","Ethik/Grundrechte","Recht"],
    "Energiewende & Netzausbau": ["Energiesysteme","Volkswirtschaft","Kommunikation"],
    "Wohnungsbau & Mieten":     ["Volkswirtschaft","Recht","Umwelt"],
    "Gesundheitsreform":        ["Public Health","Finanzen","Versorgung"],
    "Cybersicherheit Staat":    ["Daten/IT-Sicherheit","Recht","Organisation"],
    "Schule & Digitalisierung": ["Implementierung/Verwaltung","Lehrpläne","Finanzen"]
}

# kurze Phaseninfo (rechts sichtbar)
PINFO = {
    "P1": ["Nur FachBEREICHE werden zuerst festgelegt."],
    "P2": ["Thema wird auf Plattform veröffentlicht. Gremium bestätigen."],
    "P3": ["Evidenz zusammentragen (2 Runden)."],
    "P4": ["Beratung & Evidenz – Pseudo-Metriken zeigen Fortschritt."],
    "P5": ["Politische Abwägung und Entscheidung."]
}

# ---------- Story-Generator ----------
def political_pool():
    roles = ["Regierung","Opposition","Verbände","Wissenschaft","Zivilgesellschaft"]
    disc  = ["Volkswirtschaft","Public Health","Energiesysteme","Recht",
             "Ethik/Grundrechte","Daten/IT-Sicherheit","Implementierung/Verwaltung"]
    people = []
    for i in range(16):
        people.append({
            "name": f"Person {i+1}",
            "role": random.choice(roles),
            "disc": random.choice(disc),
        })
    return people

def pick_members(sectors, pool, per_sector=3):
    out = {}
    for d in sectors:
        cand = [p for p in pool if p["disc"] == d]
        rest = [p for p in pool if p["disc"] != d]
        if len(cand) < per_sector:
            cand = cand + random.sample(rest, per_sector-len(cand))
        out[d] = random.sample(cand, k=per_sector)
    return out

def decide(experts):
    # simple Spiel-Abstimmung
    yes = random.randint(8, 14); tot = 20
    return ("ADOPT" if yes >= 12 else "REJECT"), yes, tot

def storyboard(topic: str, speed: float):
    pool = political_pool()
    sectors = PROBLEMS.get(topic, [])
    experts = pick_members(sectors, pool)

    scenes = []

    # P1
    lines = [f"Gewähltes Thema: {topic}",
             "Fachbereiche werden festgelegt:",
             ", ".join(sectors) if sectors else "—"]
    scenes.append({ "phase":"P1", "title":"Thema & Bereiche", "lines":lines })

    # P2
    explines = [f"{d}: " + ", ".join(f"{e['name']} ({e['role']})" for e in lst)
                for d,lst in experts.items()]
    scenes.append({ "phase":"P2", "title":"Gremium bestätigen",
                    "lines":["Ausgewählte Expert:innen:"] + explines })

    # P3
    scenes.append({ "phase":"P3", "title":"Evidenz zusammentragen",
                    "lines":["Runde 1: Problembeschreibung","Runde 2: Maßnahmenbündel entw." ]})

    # P4
    vals = { "Evidenz": round(random.uniform(0.4, 0.9), 2),
             "Plausibilität": round(random.uniform(0.4, 0.9), 2),
             "Kosten/Nutzen": round(random.uniform(0.4, 0.9), 2) }
    scenes.append({ "phase":"P4", "title":"Beratung & Evidenz",
                    "lines":["Evidenz wird präsentiert und diskutiert.",
                             "Metriken werden laufend aktualisiert."],
                    "metrics": vals })

    # P5
    decision, yes, tot = decide(experts)
    scenes.append({ "phase":"P5", "title":"Politische Entscheidung",
                    "lines":[f"Ergebnis: {decision}. Stimmen: {yes}/{tot}"] })

    return scenes

# ---------- Rendering / Steuerung ----------
SCENES = []
idx = -1  # aktuelle Szene

def render_scene():
    s = SCENES[idx]
    set_text("sceneTitle", s.get("title",""))
    set_text("sceneText",  " · ".join(s.get("lines",[])))
    set_metrics(s.get("metrics"))
    # Infoleiste mit Phasenhinweis
    info = PINFO.get(s.get("phase",""), [])
    if info:
        set_info(info)
    render_phasebar()

def next_scene(evt=None):
    global idx
    idx += 1
    if idx >= len(SCENES):
        finish()
        return
    render_scene()

def skip_scene(evt=None):
    next_scene()

def finish():
    set_text("sceneTitle", "Ende")
    set_text("sceneText",  "Danke – Durchlauf beendet.")
    set_html("actions","")
    set_metrics(None)
    render_phasebar()

def restart(evt=None):
    # Zufälliges Thema in Dropdown setzen, UI zurücksetzen
    keys = list(PROBLEMS.keys())
    if keys:
        qs("#topic").value = random.choice(keys)
        set_text("sceneTitle","Neuer Durchlauf")
        set_text("sceneText","Thema gewählt, starte neu …")
        set_html("actions","")
        set_metrics(None)
        render_phasebar()

def start_run(evt=None):
    # Sichtbarer Start-Check
    set_info(["start_run aufgerufen ✅"])
    global SCENES, idx
    topic = qs("#topic").value
    speed = float(qs("#speed").value)
    SCENES = storyboard(topic, speed)
    idx = -1
    set_info([f"Start geklickt · Thema: {topic}",
              f"Szenen erzeugt: {len(SCENES)}"])
    next_scene()

# ---------- Bootstrap (Dropdown füllen) ----------
def _bootstrap():
    sel = qs("#topic")
    keys = list(PROBLEMS.keys())
    sel.innerHTML = "".join(f'<option value="{k}">{k}</option>' for k in keys)
    if keys:
        sel.value = keys[0]
    # Sichtbarer Check rechts:
    set_info([f"Dropdown geladen: {len(keys)} Themen"])

_bootstrap()
  </script>
</body>
</html>
